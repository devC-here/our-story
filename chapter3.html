<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chapter 3 - A Special Name</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Patrick+Hand&family=Kalam:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Patrick Hand", cursive;
        background: linear-gradient(
          135deg,
          #1a0030 0%,
          #3d0060 50%,
          #7200a8 100%
        );
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        touch-action: none;
        color: #fff;
        overflow: hidden;
        position: relative;
      }

      /* Background bubbles container */
      .bg-bubbles {
        position: fixed;
        inset: 0;
        z-index: 1;
        pointer-events: none;
        overflow: hidden;
      }

      .container {
        max-width: 800px;
        width: 100%;
        text-align: center;
        position: relative;
        z-index: 10;
      }

      .header {
        margin-bottom: 30px;
      }

      .title {
        font-family: "Caveat", cursive;
        font-size: clamp(2rem, 6vw, 3.5rem);
        font-weight: 700;
        color: #f0c8ff;
        text-shadow:
          2px 2px 0 rgba(114, 0, 168, 0.5),
          0 0 30px rgba(240, 200, 255, 0.5);
        margin-bottom: 10px;
      }

      .hint {
        font-family: "Kalam", cursive;
        font-size: clamp(1rem, 3vw, 1.3rem);
        color: #d880f8;
        font-style: italic;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      #status {
        font-family: "Caveat", cursive;
        font-size: clamp(1.3rem, 4vw, 2rem);
        font-weight: 700;
        min-height: 2.5em;
        color: #f0c8ff;
        margin-bottom: 20px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
      }

      #status.success {
        color: #4caf50;
        font-size: clamp(1.5rem, 5vw, 2.5rem);
        text-shadow: 0 0 20px rgba(76, 175, 80, 0.6);
      }

      #status.checking {
        color: #ffd700;
        animation: pulse 1s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 0.7;
        }
        50% {
          opacity: 1;
        }
      }

      .canvas-container {
        position: relative;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 16px;
        padding: 15px;
        box-shadow:
          0 10px 40px rgba(0, 0, 0, 0.3),
          inset 0 0 20px rgba(180, 64, 216, 0.1);
        margin-bottom: 25px;
        overflow: hidden;
      }

      canvas {
        width: 100%;
        height: auto;
        border-radius: 12px;
        background: #fff;
        cursor: crosshair;
        touch-action: none;
        position: relative;
        z-index: 5;
        display: block;
      }

      .controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }

      button {
        font-family: "Patrick Hand", cursive;
        padding: 12px 30px;
        font-size: clamp(0.9rem, 2.5vw, 1.1rem);
        border: 2px solid rgba(180, 64, 216, 0.5);
        border-radius: 50px;
        background: rgba(60, 0, 100, 0.4);
        backdrop-filter: blur(10px);
        color: #f0c8ff;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      button:hover {
        background: rgba(114, 0, 168, 0.5);
        border-color: #b040d8;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(180, 64, 216, 0.4);
      }

      button:active {
        transform: translateY(0);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Background pink bubbles - LOW opacity for clarity */
      .bubble {
        position: absolute;
        border-radius: 50%;
        background: radial-gradient(
          circle at 30% 30%,
          rgba(255, 182, 193, 0.4) 0%,
          rgba(255, 192, 203, 0.3) 50%,
          rgba(255, 218, 224, 0.15) 100%
        );
        box-shadow:
          inset -5px -5px 15px rgba(255, 255, 255, 0.3),
          inset 5px 5px 10px rgba(255, 182, 193, 0.2),
          0 0 20px rgba(255, 192, 203, 0.25);
        pointer-events: none;
        animation: bubbleFloat linear forwards;
      }

      @keyframes bubbleFloat {
        0% {
          transform: translateY(0) translateX(0) scale(1);
          opacity: 0;
        }
        10% {
          opacity: 0.6;
        }
        70% {
          opacity: 0.5;
        }
        100% {
          transform: translateY(-100vh) translateX(var(--drift)) scale(0.8);
          opacity: 0;
        }
      }

      /* Bubble burst effect */
      .bubble-burst {
        position: absolute;
        pointer-events: none;
        animation: burst 0.6s ease-out forwards;
      }

      @keyframes burst {
        0% {
          transform: scale(1);
          opacity: 0.7;
        }
        100% {
          transform: scale(3);
          opacity: 0;
        }
      }

      .burst-particle {
        position: absolute;
        width: 4px;
        height: 4px;
        background: rgba(255, 192, 203, 0.6);
        border-radius: 50%;
        pointer-events: none;
        animation: particleFly 0.8s ease-out forwards;
      }

      @keyframes particleFly {
        0% {
          transform: translate(0, 0) scale(1);
          opacity: 0.8;
        }
        100% {
          transform: translate(var(--tx), var(--ty)) scale(0);
          opacity: 0;
        }
      }

      /* Heart trail particles */
      .heart-trail {
        position: fixed;
        pointer-events: none;
        z-index: 15;
        animation: heartTrailFloat 1.8s ease-out forwards;
      }

      @keyframes heartTrailFloat {
        0% {
          transform: scale(1) rotate(0deg);
          opacity: 0.9;
        }
        100% {
          transform: scale(0) rotate(45deg) translateY(-50px);
          opacity: 0;
        }
      }

      /* Success overlay */
      .success-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        animation: fadeIn 0.5s ease;
      }

      .success-overlay.show {
        display: flex;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .success-message {
        background: linear-gradient(135deg, #7200a8, #b040d8);
        padding: 40px;
        border-radius: 20px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        transform: scale(0);
        animation: successPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.3s
          forwards;
      }

      @keyframes successPop {
        0% {
          transform: scale(0) rotate(-180deg);
        }
        70% {
          transform: scale(1.1) rotate(10deg);
        }
        100% {
          transform: scale(1) rotate(0deg);
        }
      }

      .success-message h2 {
        font-family: "Caveat", cursive;
        font-size: clamp(2rem, 6vw, 3.5rem);
        font-weight: 700;
        color: #fff;
        margin-bottom: 20px;
        text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .success-message p {
        font-family: "Kalam", cursive;
        font-size: clamp(1rem, 3vw, 1.4rem);
        color: #f0c8ff;
        line-height: 1.6;
      }

      /* Mobile optimization */
      @media (max-width: 768px) {
        body {
          padding: 15px;
        }

        .canvas-container {
          padding: 10px;
        }

        .controls {
          gap: 10px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Background bubbles (NOT on canvas) -->
    <div class="bg-bubbles" id="bg-bubbles"></div>

    <div class="container">
      <div class="header">
        <h1 class="title">A Special Name üíú</h1>
        <p class="hint">Guess and write what I love to call you...</p>
      </div>

      <div id="status">Write with your finger ‚ú®</div>

      <div class="canvas-container">
        <canvas id="pad" width="700" height="350"></canvas>
      </div>

      <div class="controls">
        <button onclick="clearAll()" id="clear-btn">
          üîÑ Clear & Try Again
        </button>
      </div>
    </div>

    <!-- Success overlay -->
    <div class="success-overlay" id="success-overlay">
      <div class="success-message">
        <h2>You got it! üíú</h2>
        <p>Yes, you're my Disha ‚ú®<br />My light in the darkness</p>
      </div>
    </div>

    <script>
      const canvas = document.getElementById("pad");
      const ctx = canvas.getContext("2d");
      const status = document.getElementById("status");
      const successOverlay = document.getElementById("success-overlay");
      const bgBubbles = document.getElementById("bg-bubbles");
      const clearBtn = document.getElementById("clear-btn");

      // Google Vision API Key (hidden in background)
      const API_KEY = "AIzaSyD1NV-GbpEf-5oyuOdb9b-NJcBv_Kz4W7Q";

      let drawing = false;
      let currentPoints = [];
      let recognitionTimeout = null;
      let isChecking = false;

      // Initialize Canvas with THICK line
      ctx.strokeStyle = "#7200a8";
      ctx.lineWidth = 10;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";

      // Create background bubble
      function createBubble() {
        const bubble = document.createElement("div");
        bubble.className = "bubble";

        const size = 20 + Math.random() * 80; // 20-100px
        bubble.style.width = size + "px";
        bubble.style.height = size + "px";
        bubble.style.left = Math.random() * 100 + "%";
        bubble.style.bottom = "-100px";

        const duration = 8000 + Math.random() * 7000; // 8-15 seconds
        const drift = (Math.random() - 0.5) * 100; // -50px to +50px drift
        bubble.style.setProperty("--drift", drift + "px");
        bubble.style.animationDuration = duration + "ms";

        bgBubbles.appendChild(bubble);

        // Random chance to burst mid-flight
        if (Math.random() > 0.5) {
          const burstTime = duration * (0.3 + Math.random() * 0.5); // Burst between 30-80% of journey
          setTimeout(() => {
            if (bubble.parentNode) {
              burstBubble(bubble);
            }
          }, burstTime);
        }

        // Remove after animation
        setTimeout(() => {
          if (bubble.parentNode) {
            bubble.remove();
          }
        }, duration + 100);
      }

      // Burst bubble effect
      function burstBubble(bubble) {
        const rect = bubble.getBoundingClientRect();
        const x = rect.left + rect.width / 2;
        const y = rect.top + rect.height / 2;

        // Create burst effect
        const burst = document.createElement("div");
        burst.className = "bubble-burst";
        burst.style.left = x + "px";
        burst.style.top = y + "px";
        burst.style.width = rect.width + "px";
        burst.style.height = rect.height + "px";
        burst.style.borderRadius = "50%";
        burst.style.border = "2px solid rgba(255, 192, 203, 0.5)";

        document.body.appendChild(burst);

        // Create burst particles
        for (let i = 0; i < 8; i++) {
          const particle = document.createElement("div");
          particle.className = "burst-particle";
          particle.style.left = x + "px";
          particle.style.top = y + "px";

          const angle = (Math.PI * 2 * i) / 8;
          const distance = 30 + Math.random() * 40;
          const tx = Math.cos(angle) * distance;
          const ty = Math.sin(angle) * distance;

          particle.style.setProperty("--tx", tx + "px");
          particle.style.setProperty("--ty", ty + "px");

          document.body.appendChild(particle);

          setTimeout(() => particle.remove(), 800);
        }

        setTimeout(() => burst.remove(), 600);
        bubble.remove();
      }

      // Generate bubbles continuously in background
      setInterval(createBubble, 400); // New bubble every 400ms
      for (let i = 0; i < 15; i++) {
        setTimeout(createBubble, i * 300);
      }

      // Event Handlers
      const getXY = (e) => {
        const r = canvas.getBoundingClientRect();
        const t = e.touches ? e.touches[0] : e;
        return {
          x: (t.clientX - r.left) * (canvas.width / r.width),
          y: (t.clientY - r.top) * (canvas.height / r.height),
        };
      };

      canvas.addEventListener("mousedown", startDrawing);
      canvas.addEventListener("touchstart", startDrawing);
      window.addEventListener("mousemove", draw);
      window.addEventListener("touchmove", draw);
      window.addEventListener("mouseup", stopDrawing);
      window.addEventListener("touchend", stopDrawing);

      function startDrawing(e) {
        e.preventDefault();
        drawing = true;
        currentPoints = [getXY(e)];
        ctx.beginPath();

        if (recognitionTimeout) {
          clearTimeout(recognitionTimeout);
          recognitionTimeout = null;
        }
      }

      function draw(e) {
        if (!drawing) return;
        e.preventDefault();
        const p = getXY(e);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        currentPoints.push(p);

        if (currentPoints.length % 5 === 0) {
          createHeartTrail(p.x, p.y);
        }
      }

      function stopDrawing() {
        if (!drawing) return;
        drawing = false;

        if (recognitionTimeout) {
          clearTimeout(recognitionTimeout);
        }

        recognitionTimeout = setTimeout(() => {
          recognizeHandwriting();
        }, 2000); // 4.5 seconds

        currentPoints = [];
      }

      function createHeartTrail(canvasX, canvasY) {
        const rect = canvas.getBoundingClientRect();
        const screenX = rect.left + (canvasX / canvas.width) * rect.width;
        const screenY = rect.top + (canvasY / canvas.height) * rect.height;

        const heart = document.createElement("div");
        heart.className = "heart-trail";
        heart.innerHTML = "üíó";
        heart.style.left = screenX + "px";
        heart.style.top = screenY + "px";
        heart.style.fontSize = 10 + Math.random() * 14 + "px";

        document.body.appendChild(heart);
        setTimeout(() => heart.remove(), 1800);
      }

      async function recognizeHandwriting() {
        if (isChecking) return;

        isChecking = true;
        status.innerText = "Checking... ‚ú®";
        status.classList.add("checking");
        clearBtn.disabled = true;

        try {
          const imageData = canvas.toDataURL("image/png").split(",")[1];

          const response = await fetch(
            `https://vision.googleapis.com/v1/images:annotate?key=${API_KEY}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                requests: [
                  {
                    image: {
                      content: imageData,
                    },
                    features: [
                      {
                        type: "DOCUMENT_TEXT_DETECTION",
                        maxResults: 1,
                      },
                    ],
                  },
                ],
              }),
            },
          );

          const data = await response.json();

          if (data.responses && data.responses[0].fullTextAnnotation) {
            const detectedText = data.responses[0].fullTextAnnotation.text
              .toLowerCase()
              .trim()
              .replace(/\s+/g, "");

            console.log("Detected:", detectedText);

            if (detectedText === "disha" || detectedText.includes("disha")) {
              celebrateSuccess();
            } else {
              status.innerText = "Not quite... Try again! üíú";
              status.classList.remove("checking");
            }
          } else {
            status.innerText = "Couldn't read that. Try writing clearer! ‚úçÔ∏è";
            status.classList.remove("checking");
          }
        } catch (error) {
          console.error("Recognition error:", error);
          status.innerText = "Something went wrong. Try again! üîÑ";
          status.classList.remove("checking");
        }

        isChecking = false;
        clearBtn.disabled = false;
      }

      function celebrateSuccess() {
        status.innerText = "‚ú® Perfect! You got it! ‚ú®";
        status.classList.remove("checking");
        status.classList.add("success");

        for (let i = 0; i < 60; i++) {
          setTimeout(() => {
            createConfetti();
          }, i * 25);
        }

        setTimeout(() => {
          successOverlay.classList.add("show");
        }, 1000);
      }

      function createConfetti() {
        const colors = [
          "#ff6b9d",
          "#b040d8",
          "#ffd700",
          "#4caf50",
          "#f0c8ff",
          "#ff8ca8",
        ];
        const confetti = document.createElement("div");

        confetti.style.position = "fixed";
        confetti.style.width = 6 + Math.random() * 12 + "px";
        confetti.style.height = 6 + Math.random() * 12 + "px";
        confetti.style.background =
          colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = Math.random() * 100 + "%";
        confetti.style.top = "-20px";
        confetti.style.borderRadius = Math.random() > 0.5 ? "50%" : "2px";
        confetti.style.zIndex = "1000";
        confetti.style.pointerEvents = "none";

        document.body.appendChild(confetti);

        confetti.animate(
          [
            {
              top: "-20px",
              transform: "rotate(0deg)",
              opacity: 1,
            },
            {
              top: "100vh",
              transform: `rotate(${360 + Math.random() * 360}deg)`,
              opacity: 0,
            },
          ],
          {
            duration: 2000 + Math.random() * 1500,
            easing: "cubic-bezier(0.25, 0.46, 0.45, 0.94)",
          },
        );

        setTimeout(() => confetti.remove(), 3500);
      }

      function clearAll() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (recognitionTimeout) {
          clearTimeout(recognitionTimeout);
          recognitionTimeout = null;
        }

        status.innerText = "Write with your finger ‚ú®";
        status.classList.remove("success", "checking");
        successOverlay.classList.remove("show");
      }

      setTimeout(() => {
        status.innerText = "Guess the name I call you üíú";
      }, 1500);
    </script>
  </body>
</html>
